<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador Gold - Nardoto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #141419;
            --bg-card-hover: #1a1a22;
            --bg-input: #0d0d12;
            --primary: #FF6B35;
            --primary-light: #FF8C5A;
            --primary-dark: #E85A2A;
            --success: #22c55e;
            --success-dark: #16a34a;
            --danger: #ef4444;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-light: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(255, 107, 53, 0.5);
            --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #E85A2A 100%);
            --gradient-glow: radial-gradient(ellipse at center, rgba(255, 107, 53, 0.15) 0%, transparent 70%);
            --shadow-primary: 0 4px 20px rgba(255, 107, 53, 0.3);
            --shadow-primary-lg: 0 8px 30px rgba(255, 107, 53, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 50px 20px 30px;
            position: relative;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 300px;
            background: var(--gradient-glow);
            pointer-events: none;
        }
        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 2.5rem;
            font-weight: 400;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 8px;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px 60px;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .card:hover {
            background: var(--bg-card-hover);
        }
        .card-title {
            font-family: 'DM Serif Display', serif;
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 18px; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
        }
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.15);
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }
        textarea {
            resize: vertical;
            min-height: 160px;
        }

        /* Options Panel */
        .options-panel {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 18px;
            display: none;
        }
        .options-panel.show { display: block; }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        .option-item label {
            margin-bottom: 0;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .option-item input[type="text"] {
            width: 120px;
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        /* Division Rows */
        .division-section { margin-bottom: 18px; }
        .division-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .division-row.active {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.05);
        }
        .division-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 90px;
            font-size: 0.9rem;
        }
        .division-row.active .division-label {
            color: var(--primary);
        }
        .division-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            flex-wrap: wrap;
        }
        .input-mini {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .input-mini label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .input-mini input {
            width: 70px;
            padding: 8px 10px;
            text-align: center;
            font-weight: 600;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 18px;
        }
        .btn {
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary-lg);
        }
        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }
        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            color: var(--primary);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }
        .stat-value {
            font-family: 'DM Serif Display', serif;
            font-size: 1.8rem;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Blocks */
        .blocks-container {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .block {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 14px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .block:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        .block:hover::before { opacity: 1; }
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .block-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        .block-meta {
            display: flex;
            gap: 14px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .block-controls {
            display: flex;
            gap: 6px;
        }
        .block-content {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.9rem;
            min-height: 60px;
            transition: all 0.3s ease;
        }
        .block-content:focus {
            outline: none;
            border-color: var(--primary);
            color: var(--text-primary);
        }
        .block-content.edited {
            border-color: var(--success);
        }
        .btn-block {
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 14px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Merge Section */
        .merge-section {
            background: var(--bg-input);
            border: 1px dashed var(--border-light);
            border-radius: 12px;
            padding: 16px;
        }
        .merge-section input[type="file"] {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }
        .footer-quote {
            font-family: 'DM Serif Display', serif;
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        .footer-brand {
            margin-top: 12px;
        }
        .footer-brand a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        .footer-brand a:hover { text-decoration: underline; }

        /* Error */
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 14px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            animation: shake 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Toggle Button */
        .toggle-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .toggle-btn:hover, .toggle-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #preview { display: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">&#9889;</div>
            <h1>Otimizador Gold</h1>
        </div>
        <p class="subtitle">Divisor de texto inteligente para legendas e audiovisual</p>
    </header>

    <main class="container">
        <!-- Input Card -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">&#128221;</span>
                Configuracoes
            </h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="fileName">Nome do arquivo</label>
                    <input type="text" id="fileName" placeholder="Ex: meu-video-legenda">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button class="toggle-btn" id="toggleOptionsBtn">&#9881; Opcoes</button>
                </div>
            </div>

            <!-- Options Panel -->
            <div id="optionsPanel" class="options-panel">
                <div class="options-grid">
                    <div class="option-item">
                        <input type="checkbox" id="filterNumbers">
                        <label for="filterNumbers">Filtrar numeros</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="clearAfterExport">
                        <label for="clearAfterExport">Limpar apos exportar</label>
                    </div>
                    <div class="option-item">
                        <label>Ignorar:</label>
                        <input type="text" id="ignoreText" placeholder="texto...">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="textInput">Texto para dividir</label>
                <textarea id="textInput" rows="8" placeholder="Cole seu texto aqui..."></textarea>
            </div>

            <!-- Division Controls -->
            <div class="division-section">
                <label>Modo de Divisao</label>

                <div class="division-row" id="charDivisionRow">
                    <span class="division-label">&#128196; Caracteres</span>
                    <div class="division-controls">
                        <div class="input-mini">
                            <label>Max</label>
                            <input type="number" id="charCount" value="490" min="50" max="2000">
                        </div>
                        <div class="input-mini">
                            <label>c/s</label>
                            <input type="number" id="readingRate" value="14" min="10" max="50">
                        </div>
                        <button class="btn btn-primary btn-sm" id="divideByCharsBtn">Dividir</button>
                    </div>
                </div>

                <div class="division-row" id="wordDivisionRow">
                    <span class="division-label">&#128209; Palavras</span>
                    <div class="division-controls">
                        <div class="input-mini">
                            <label>Max</label>
                            <input type="number" id="wordCount" value="50" min="10" max="500">
                        </div>
                        <button class="btn btn-secondary btn-sm" id="divideByWordsBtn">Dividir</button>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" id="exportBtn" disabled>
                    &#128190; Exportar SRT + TXT
                </button>
                <button class="btn btn-secondary" id="resetBtn">
                    &#128260; Limpar
                </button>
            </div>
        </div>

        <!-- Stats Card -->
        <div id="statsCard" class="card" style="display: none;">
            <h2 class="card-title">
                <span class="card-title-icon">&#128202;</span>
                Estatisticas
            </h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalChars">0</div>
                    <div class="stat-label">Caracteres</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalWords">0</div>
                    <div class="stat-label">Palavras</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalBlocks">0</div>
                    <div class="stat-label">Blocos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalDuration">0:00</div>
                    <div class="stat-label">Duracao</div>
                </div>
            </div>
        </div>

        <!-- Blocks Card -->
        <div id="blocksCard" class="card" style="display: none;">
            <h2 class="card-title">
                <span class="card-title-icon">&#128230;</span>
                Blocos Gerados
                <button class="btn btn-secondary btn-sm" id="addBlockBtn" style="margin-left: auto;">+ Bloco</button>
            </h2>
            <div id="blocks" class="blocks-container"></div>
        </div>

        <!-- Merge SRT Card -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">&#128279;</span>
                Juntar Arquivos SRT
            </h2>
            <div class="merge-section">
                <label for="srtFiles">Selecione os arquivos SRT:</label>
                <input type="file" id="srtFiles" accept=".srt" multiple>
                <div class="btn-group" style="margin-top: 12px;">
                    <button class="btn btn-primary btn-sm" id="mergeSrtsBtn">Juntar SRTs</button>
                    <button class="btn btn-secondary btn-sm" id="cancelMergeBtn">Cancelar</button>
                </div>
                <div id="mergeStatus" style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);"></div>
            </div>
        </div>

        <div id="preview"></div>
    </main>

    <footer class="footer">
        <p class="footer-quote">"O sonho e a coisa mais real que existe!"</p>
        <p class="footer-brand">
            Feito com &#10084; por <a href="https://nardoto.com.br" target="_blank">Nardoto</a>
        </p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ========================================
        // MULTI-LANGUAGE ABBREVIATIONS DATABASE
        // ========================================
        const ABBREVIATIONS = {
            en: ['mr', 'mrs', 'ms', 'dr', 'prof', 'sr', 'jr', 'vs', 'etc', 'al', 'eg', 'ie', 'inc', 'ltd', 'co', 'corp', 'dept', 'est', 'vol', 'rev', 'ed', 'pp', 'approx', 'govt', 'intl', 'natl', 'jan', 'feb', 'mar', 'apr', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'fig', 'ref', 'sec', 'ch', 'pg'],
            pt: ['sr', 'sra', 'srta', 'dr', 'dra', 'prof', 'profa', 'eng', 'adv', 'av', 'etc', 'ex', 'obs', 'vol', 'cap', 'ed', 'num', 'tel', 'cel', 'ltda', 'cia', 'gov', 'min', 'sec', 'dep', 'jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez', 'fig', 'tab', 'ref', 'art'],
            es: ['sr', 'sra', 'srta', 'dr', 'dra', 'prof', 'profa', 'ing', 'lic', 'arq', 'etc', 'ej', 'vol', 'cap', 'ed', 'tel', 'cel', 'gov', 'min', 'sec', 'dip', 'ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic', 'fig', 'tab', 'ref', 'art']
        };

        const CONJUNCTIONS = {
            en: ['and', 'or', 'but', 'nor', 'for', 'yet', 'so', 'because', 'although', 'while', 'when', 'if', 'unless', 'until', 'since', 'after', 'before', 'however', 'therefore', 'moreover', 'furthermore', 'meanwhile', 'otherwise', 'nevertheless', 'then', 'also'],
            pt: ['e', 'ou', 'mas', 'porem', 'contudo', 'todavia', 'entretanto', 'nem', 'pois', 'logo', 'portanto', 'assim', 'entao', 'porque', 'que', 'se', 'caso', 'embora', 'quando', 'enquanto', 'onde', 'como', 'alem disso', 'ou seja', 'isto e'],
            es: ['y', 'e', 'o', 'u', 'pero', 'sino', 'mas', 'aunque', 'sin embargo', 'ni', 'pues', 'luego', 'por lo tanto', 'asi', 'entonces', 'porque', 'que', 'si', 'cuando', 'mientras', 'donde', 'como', 'ademas', 'es decir']
        };

        const ALL_ABBREVIATIONS = new Set([...ABBREVIATIONS.en, ...ABBREVIATIONS.pt, ...ABBREVIATIONS.es].map(a => a.toLowerCase().replace(/\./g, '')));
        const ALL_CONJUNCTIONS = new Set([...CONJUNCTIONS.en, ...CONJUNCTIONS.pt, ...CONJUNCTIONS.es].map(c => c.toLowerCase()));

        // Constants
        const PAUSE_TIME = 0.9;
        const TOLERANCE_PERCENT = 0.15;
        const MIN_BLOCK_PERCENT = 0.5;

        // State
        let currentDivisionMode = null;

        // DOM Elements
        const toggleOptionsBtn = document.getElementById('toggleOptionsBtn');
        const optionsPanel = document.getElementById('optionsPanel');
        const textInput = document.getElementById('textInput');
        const fileNameInput = document.getElementById('fileName');
        const charCountInput = document.getElementById('charCount');
        const wordCountInput = document.getElementById('wordCount');
        const readingRateInput = document.getElementById('readingRate');
        const filterNumbersCheckbox = document.getElementById('filterNumbers');
        const clearAfterExportCheckbox = document.getElementById('clearAfterExport');
        const ignoreTextInput = document.getElementById('ignoreText');
        const blocksDiv = document.getElementById('blocks');
        const exportBtn = document.getElementById('exportBtn');
        const charDivisionRow = document.getElementById('charDivisionRow');
        const wordDivisionRow = document.getElementById('wordDivisionRow');

        // Toggle Options
        toggleOptionsBtn.addEventListener('click', () => {
            optionsPanel.classList.toggle('show');
            toggleOptionsBtn.classList.toggle('active');
        });

        // Division Buttons
        document.getElementById('divideByCharsBtn').addEventListener('click', () => {
            divideTextByChars();
            setDivisionMode('chars');
        });

        document.getElementById('divideByWordsBtn').addEventListener('click', () => {
            divideTextByWords();
            setDivisionMode('words');
        });

        document.getElementById('resetBtn').addEventListener('click', resetForm);
        document.getElementById('exportBtn').addEventListener('click', exportBoth);
        document.getElementById('addBlockBtn').addEventListener('click', () => createBlock(''));

        // SRT Merge
        document.getElementById('mergeSrtsBtn').addEventListener('click', mergeSrtFiles);
        document.getElementById('cancelMergeBtn').addEventListener('click', () => {
            document.getElementById('srtFiles').value = '';
            document.getElementById('mergeStatus').textContent = '';
        });

        function setDivisionMode(mode) {
            currentDivisionMode = mode;
            charDivisionRow.classList.toggle('active', mode === 'chars');
            wordDivisionRow.classList.toggle('active', mode === 'words');
            exportBtn.disabled = false;
        }

        // ========================================
        // TEXT PROCESSING
        // ========================================
        function formatText(text) {
            return text
                .replace(/["«»""]/g, "'")
                .replace(/['']/g, "'")
                .replace(/[—–]/g, " - ")
                .replace(/\.{3,}/g, "...")
                .replace(/…/g, "...")
                .replace(/\n/g, " ")
                .replace(/\s+([.,!?;:])/g, "$1")
                .replace(/([.,!?;:])([a-zA-ZáàâãéèêíìîóòôõúùûñçÁÀÂÃÉÈÊÍÌÎÓÒÔÕÚÙÛÑÇ])/g, "$1 $2")
                .replace(/\s+/g, ' ')
                .trim();
        }

        function isAbbreviation(word) {
            if (!word) return false;
            const cleaned = word.toLowerCase().replace(/[.,!?;:]+$/, '').replace(/\./g, '');
            return ALL_ABBREVIATIONS.has(cleaned);
        }

        function splitIntoSentences(text) {
            const sentences = [];
            let currentSentence = '';
            let i = 0;

            while (i < text.length) {
                const char = text[i];
                currentSentence += char;

                if (/[.!?]/.test(char)) {
                    let j = i + 1;
                    while (j < text.length && /[.!?]/.test(text[j])) {
                        currentSentence += text[j];
                        j++;
                    }

                    let whitespace = '';
                    while (j < text.length && /\s/.test(text[j])) {
                        whitespace += text[j];
                        j++;
                    }

                    const wordsBefore = currentSentence.trim().split(/\s+/);
                    const lastWord = wordsBefore[wordsBefore.length - 1];
                    const nextChar = text[j];

                    const isRealBreak = !isAbbreviation(lastWord) &&
                                        !(nextChar && /[a-záàâãéèêíìîóòôõúùûñç\d]/.test(nextChar)) &&
                                        whitespace.length > 0;

                    if (isRealBreak && currentSentence.trim().length > 0) {
                        sentences.push(currentSentence.trim());
                        currentSentence = '';
                        i = j - 1;
                    }
                }
                i++;
            }

            if (currentSentence.trim()) {
                sentences.push(currentSentence.trim());
            }

            return sentences.length > 0 ? sentences : [text];
        }

        function findBestCutPoint(text, maxLength) {
            const maxWithTolerance = Math.floor(maxLength * (1 + TOLERANCE_PERCENT));
            const cutCandidates = [];

            // Sentence endings
            let match;
            const sentenceEndRegex = /[.!?]+\s+/g;
            while ((match = sentenceEndRegex.exec(text)) !== null) {
                const pos = match.index + match[0].length;
                if (pos <= maxWithTolerance) {
                    cutCandidates.push({ pos, priority: 1 });
                }
            }

            // Clause separators
            const clauseRegex = /[;:]\s+/g;
            while ((match = clauseRegex.exec(text)) !== null) {
                const pos = match.index + match[0].length;
                if (pos <= maxWithTolerance) {
                    cutCandidates.push({ pos, priority: 2 });
                }
            }

            // Commas
            const commaRegex = /,\s+/g;
            while ((match = commaRegex.exec(text)) !== null) {
                const pos = match.index + match[0].length;
                if (pos <= maxWithTolerance) {
                    cutCandidates.push({ pos, priority: 3 });
                }
            }

            // Spaces
            const spaceRegex = /\s+/g;
            while ((match = spaceRegex.exec(text)) !== null) {
                const pos = match.index + match[0].length;
                if (pos <= maxWithTolerance) {
                    cutCandidates.push({ pos, priority: 4 });
                }
            }

            if (cutCandidates.length === 0) {
                return { pos: maxLength };
            }

            cutCandidates.sort((a, b) => {
                if (a.priority === b.priority) {
                    return Math.abs(maxLength - a.pos) - Math.abs(maxLength - b.pos);
                }
                return a.priority - b.priority;
            });

            const bestPriority = cutCandidates[0].priority;
            const bestCandidates = cutCandidates.filter(c => c.priority === bestPriority);

            let bestCandidate = bestCandidates[0];
            for (const candidate of bestCandidates) {
                if (candidate.pos >= maxLength * 0.7 && candidate.pos <= maxWithTolerance) {
                    if (candidate.pos > bestCandidate.pos) {
                        bestCandidate = candidate;
                    }
                }
            }

            return bestCandidate;
        }

        function splitLongSentence(sentence, maxLength) {
            const parts = [];
            let remaining = sentence;

            while (remaining.length > maxLength) {
                const cutPoint = findBestCutPoint(remaining, maxLength);
                if (cutPoint.pos <= 0 || cutPoint.pos >= remaining.length) {
                    parts.push(remaining.substring(0, maxLength).trim());
                    remaining = remaining.substring(maxLength).trim();
                } else {
                    parts.push(remaining.substring(0, cutPoint.pos).trim());
                    remaining = remaining.substring(cutPoint.pos).trim();
                }
            }

            if (remaining.trim()) {
                parts.push(remaining.trim());
            }

            return parts;
        }

        // ========================================
        // DIVISION FUNCTIONS
        // ========================================
        function getTextBlocksWithCustomLength(text, maxLength) {
            const blocks = [];
            let currentBlock = "";
            const maxWithTolerance = Math.floor(maxLength * (1 + TOLERANCE_PERCENT));
            const minBlockLength = Math.floor(maxLength * MIN_BLOCK_PERCENT);

            const formattedText = formatText(text);
            const sentences = splitIntoSentences(formattedText);

            const flushCurrentBlock = () => {
                if (currentBlock.trim()) {
                    blocks.push(currentBlock.trim());
                    currentBlock = "";
                }
            };

            for (const sentence of sentences) {
                const trimmedSentence = sentence.trim();
                if (!trimmedSentence) continue;

                if (trimmedSentence.length > maxWithTolerance) {
                    flushCurrentBlock();
                    const splitParts = splitLongSentence(trimmedSentence, maxLength);
                    for (let i = 0; i < splitParts.length - 1; i++) {
                        blocks.push(splitParts[i]);
                    }
                    currentBlock = splitParts[splitParts.length - 1] + " ";
                    continue;
                }

                const potentialBlock = currentBlock + trimmedSentence;

                if (potentialBlock.length > maxLength) {
                    if (currentBlock.trim().length >= minBlockLength) {
                        flushCurrentBlock();
                        currentBlock = trimmedSentence + " ";
                    } else {
                        if (potentialBlock.length <= maxWithTolerance) {
                            currentBlock = potentialBlock + " ";
                            flushCurrentBlock();
                        } else {
                            flushCurrentBlock();
                            currentBlock = trimmedSentence + " ";
                        }
                    }
                } else {
                    currentBlock += trimmedSentence + " ";
                    if (currentBlock.length >= maxLength) {
                        flushCurrentBlock();
                    }
                }
            }

            flushCurrentBlock();
            return blocks.filter(b => b.length > 0);
        }

        function getTextBlocksByWords(text, wordsPerBlock) {
            const blocks = [];
            let currentWords = [];
            let currentCount = 0;
            const maxWithTolerance = Math.floor(wordsPerBlock * (1 + TOLERANCE_PERCENT));
            const minBlockWords = Math.floor(wordsPerBlock * MIN_BLOCK_PERCENT);

            const formattedText = formatText(text);
            const sentences = splitIntoSentences(formattedText);

            const flushCurrent = () => {
                if (currentWords.length > 0) {
                    blocks.push(currentWords.join(' ').trim());
                    currentWords = [];
                    currentCount = 0;
                }
            };

            for (const sentence of sentences) {
                const tokens = sentence.trim().split(/\s+/).filter(Boolean);
                if (tokens.length === 0) continue;

                const sentenceWordCount = tokens.length;

                if (currentCount + sentenceWordCount <= maxWithTolerance) {
                    currentWords.push(...tokens);
                    currentCount += sentenceWordCount;
                    if (currentCount >= wordsPerBlock) {
                        flushCurrent();
                    }
                } else {
                    if (currentCount >= minBlockWords) {
                        flushCurrent();
                    }

                    if (sentenceWordCount <= maxWithTolerance) {
                        currentWords.push(...tokens);
                        currentCount = sentenceWordCount;
                        if (currentCount >= wordsPerBlock) {
                            flushCurrent();
                        }
                    } else {
                        const sentenceText = tokens.join(' ');
                        const avgCharsPerWord = sentenceText.length / sentenceWordCount;
                        const targetChars = Math.floor(wordsPerBlock * avgCharsPerWord);
                        const parts = splitLongSentence(sentenceText, targetChars);

                        for (const part of parts) {
                            const partTokens = part.split(/\s+/).filter(Boolean);
                            if (currentCount + partTokens.length <= maxWithTolerance) {
                                currentWords.push(...partTokens);
                                currentCount += partTokens.length;
                            } else {
                                if (currentCount >= minBlockWords) {
                                    flushCurrent();
                                }
                                currentWords.push(...partTokens);
                                currentCount = partTokens.length;
                            }
                            if (currentCount >= wordsPerBlock) {
                                flushCurrent();
                            }
                        }
                    }
                }
            }

            flushCurrent();
            return blocks.filter(b => b.length > 0);
        }

        // ========================================
        // UI HANDLERS
        // ========================================
        function applyFilters(text) {
            const ignored = ignoreTextInput.value.trim();
            if (ignored) {
                const regex = new RegExp(ignored.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                text = text.replace(regex, '');
            }
            if (filterNumbersCheckbox.checked) {
                text = text.replace(/\d+/g, '');
            }
            return text;
        }

        function divideTextByChars() {
            const charCount = parseInt(charCountInput.value, 10);
            if (isNaN(charCount) || charCount <= 0) {
                showError("Por favor, insira um numero valido de caracteres.");
                return;
            }

            let text = applyFilters(textInput.value);
            const blocks = getTextBlocksWithCustomLength(text, charCount);
            renderBlocks(blocks, text);
        }

        function divideTextByWords() {
            const wordCount = parseInt(wordCountInput.value, 10);
            if (isNaN(wordCount) || wordCount <= 0) {
                showError("Por favor, insira um numero valido de palavras.");
                return;
            }

            let text = applyFilters(textInput.value);
            const blocks = getTextBlocksByWords(text, wordCount);
            renderBlocks(blocks, text);
        }

        function renderBlocks(blocks, originalText) {
            blocksDiv.innerHTML = '';

            const totalChars = originalText.length;
            const totalWords = originalText.split(/\s+/).filter(w => w.length > 0).length;
            const readingRate = parseInt(readingRateInput.value, 10);

            let totalDuration = 0;
            blocks.forEach((block, index) => {
                totalDuration += block.length / readingRate + PAUSE_TIME;
                createBlock(block, index + 1);
            });

            // Update stats
            document.getElementById('totalChars').textContent = totalChars.toLocaleString();
            document.getElementById('totalWords').textContent = totalWords.toLocaleString();
            document.getElementById('totalBlocks').textContent = blocks.length;

            const minutes = Math.floor(totalDuration / 60);
            const seconds = Math.floor(totalDuration % 60);
            document.getElementById('totalDuration').textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;

            document.getElementById('statsCard').style.display = 'block';
            document.getElementById('blocksCard').style.display = 'block';

            document.getElementById('statsCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function createBlock(content, number = null) {
            const blockDiv = document.createElement('div');
            blockDiv.classList.add('block');

            const blockNum = number || (blocksDiv.children.length + 1);
            const charCount = content.length;
            const wordCount = content.split(/\s+/).filter(w => w.length > 0).length;

            blockDiv.innerHTML = `
                <div class="block-header">
                    <span class="block-title">Bloco ${blockNum}</span>
                    <div class="block-meta">
                        <span class="char-count">${charCount} chars</span>
                        <span class="word-count">${wordCount} palavras</span>
                    </div>
                    <div class="block-controls">
                        <button class="btn btn-secondary btn-block btn-copy" title="Copiar">&#128203;</button>
                        <button class="btn btn-secondary btn-block btn-add" title="Adicionar abaixo">&#10133;</button>
                        <button class="btn btn-danger btn-block btn-delete" title="Excluir">&#10060;</button>
                    </div>
                </div>
                <div class="block-content" contenteditable="true">${content}</div>
            `;

            // Event listeners
            const contentDiv = blockDiv.querySelector('.block-content');
            contentDiv.addEventListener('input', () => {
                const text = contentDiv.innerText;
                blockDiv.querySelector('.char-count').textContent = `${text.length} chars`;
                blockDiv.querySelector('.word-count').textContent = `${text.split(/\s+/).filter(Boolean).length} palavras`;
                contentDiv.classList.add('edited');
            });

            blockDiv.querySelector('.btn-copy').addEventListener('click', () => {
                navigator.clipboard.writeText(contentDiv.innerText);
                const btn = blockDiv.querySelector('.btn-copy');
                btn.innerHTML = '&#10003;';
                setTimeout(() => { btn.innerHTML = '&#128203;'; }, 1500);
            });

            blockDiv.querySelector('.btn-add').addEventListener('click', () => {
                const newBlock = document.createElement('div');
                createBlockElement(newBlock, '');
                blockDiv.after(newBlock);
                updateBlockNumbers();
            });

            blockDiv.querySelector('.btn-delete').addEventListener('click', () => {
                blockDiv.remove();
                updateBlockNumbers();
            });

            blocksDiv.appendChild(blockDiv);
        }

        function createBlockElement(container, content) {
            container.classList.add('block');
            const blockNum = blocksDiv.children.length + 1;

            container.innerHTML = `
                <div class="block-header">
                    <span class="block-title">Bloco ${blockNum}</span>
                    <div class="block-meta">
                        <span class="char-count">0 chars</span>
                        <span class="word-count">0 palavras</span>
                    </div>
                    <div class="block-controls">
                        <button class="btn btn-secondary btn-block btn-copy" title="Copiar">&#128203;</button>
                        <button class="btn btn-secondary btn-block btn-add" title="Adicionar abaixo">&#10133;</button>
                        <button class="btn btn-danger btn-block btn-delete" title="Excluir">&#10060;</button>
                    </div>
                </div>
                <div class="block-content" contenteditable="true">${content}</div>
            `;

            const contentDiv = container.querySelector('.block-content');
            contentDiv.addEventListener('input', () => {
                const text = contentDiv.innerText;
                container.querySelector('.char-count').textContent = `${text.length} chars`;
                container.querySelector('.word-count').textContent = `${text.split(/\s+/).filter(Boolean).length} palavras`;
            });

            container.querySelector('.btn-copy').addEventListener('click', () => {
                navigator.clipboard.writeText(contentDiv.innerText);
            });

            container.querySelector('.btn-add').addEventListener('click', () => {
                const newBlock = document.createElement('div');
                createBlockElement(newBlock, '');
                container.after(newBlock);
                updateBlockNumbers();
            });

            container.querySelector('.btn-delete').addEventListener('click', () => {
                container.remove();
                updateBlockNumbers();
            });
        }

        function updateBlockNumbers() {
            const blocks = blocksDiv.querySelectorAll('.block');
            blocks.forEach((block, index) => {
                block.querySelector('.block-title').textContent = `Bloco ${index + 1}`;
            });
            document.getElementById('totalBlocks').textContent = blocks.length;
        }

        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();

            const errorDiv = document.createElement('div');
            errorDiv.classList.add('error');
            errorDiv.textContent = message;
            document.querySelector('.container').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 4000);
        }

        function resetForm() {
            textInput.value = '';
            fileNameInput.value = '';
            charCountInput.value = '490';
            wordCountInput.value = '50';
            readingRateInput.value = '14';
            ignoreTextInput.value = '';
            filterNumbersCheckbox.checked = false;
            clearAfterExportCheckbox.checked = false;
            blocksDiv.innerHTML = '';
            document.getElementById('statsCard').style.display = 'none';
            document.getElementById('blocksCard').style.display = 'none';
            currentDivisionMode = null;
            charDivisionRow.classList.remove('active');
            wordDivisionRow.classList.remove('active');
            exportBtn.disabled = true;
        }

        // ========================================
        // EXPORT FUNCTIONS
        // ========================================
        function exportBoth() {
            if (!currentDivisionMode) {
                showError('Primeiro divida o texto.');
                return;
            }
            exportToSrt();
            exportToTxt();

            if (clearAfterExportCheckbox.checked) {
                textInput.value = '';
            }
        }

        function formatTimestamp(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const milliseconds = Math.round((totalSeconds - Math.floor(totalSeconds)) * 1000);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')},${String(milliseconds).padStart(3, '0')}`;
        }

        function exportToSrt() {
            const readingRate = parseInt(readingRateInput.value, 10);
            const blocks = blocksDiv.querySelectorAll('.block-content');
            let srtContent = '';
            let currentTime = 0;

            blocks.forEach((block, index) => {
                const text = block.innerText.trim();
                if (!text) return;

                const duration = text.length / readingRate;
                const startTime = formatTimestamp(currentTime);
                const endTime = formatTimestamp(currentTime + duration);

                srtContent += `${index + 1}\n${startTime} --> ${endTime}\n${text}\n\n`;
                currentTime += duration + PAUSE_TIME;
            });

            const fileName = fileNameInput.value || 'subtitles';
            const blob = new Blob([srtContent.trim()], { type: 'text/srt' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.srt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToTxt() {
            const blocks = blocksDiv.querySelectorAll('.block-content');
            let txtContent = '';

            blocks.forEach((block, index) => {
                const text = block.innerText.trim();
                if (text) {
                    txtContent += `Bloco ${index + 1}:\n${text}\n\n`;
                }
            });

            const fileName = fileNameInput.value || 'documento';
            const blob = new Blob([txtContent.trim()], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========================================
        // SRT MERGE
        // ========================================
        async function mergeSrtFiles() {
            const fileInput = document.getElementById('srtFiles');
            const statusDiv = document.getElementById('mergeStatus');
            const files = fileInput.files;

            if (files.length < 2) {
                statusDiv.textContent = 'Selecione pelo menos 2 arquivos SRT.';
                return;
            }

            statusDiv.textContent = 'Processando...';

            try {
                const srtContents = [];
                for (const file of files) {
                    const content = await file.text();
                    srtContents.push({ name: file.name, content });
                }

                // Sort by filename
                srtContents.sort((a, b) => a.name.localeCompare(b.name));

                let mergedContent = '';
                let blockIndex = 1;
                let timeOffset = 0;

                for (const srt of srtContents) {
                    const blocks = parseSrt(srt.content);

                    for (const block of blocks) {
                        const startSeconds = parseTimestamp(block.start) + timeOffset;
                        const endSeconds = parseTimestamp(block.end) + timeOffset;

                        mergedContent += `${blockIndex}\n`;
                        mergedContent += `${formatTimestamp(startSeconds)} --> ${formatTimestamp(endSeconds)}\n`;
                        mergedContent += `${block.text}\n\n`;
                        blockIndex++;
                    }

                    // Get last timestamp for offset
                    if (blocks.length > 0) {
                        timeOffset = parseTimestamp(blocks[blocks.length - 1].end) + timeOffset + 1;
                    }
                }

                // Download merged file
                const blob = new Blob([mergedContent.trim()], { type: 'text/srt' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'merged.srt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                statusDiv.textContent = `${files.length} arquivos unidos com sucesso!`;
                fileInput.value = '';
            } catch (error) {
                statusDiv.textContent = 'Erro ao processar arquivos: ' + error.message;
            }
        }

        function parseSrt(content) {
            const blocks = [];
            const lines = content.split('\n');
            let i = 0;

            while (i < lines.length) {
                // Skip empty lines and block number
                while (i < lines.length && (lines[i].trim() === '' || /^\d+$/.test(lines[i].trim()))) {
                    i++;
                }

                if (i >= lines.length) break;

                // Parse timestamp line
                const timestampLine = lines[i].trim();
                const timestampMatch = timestampLine.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);

                if (timestampMatch) {
                    const start = timestampMatch[1];
                    const end = timestampMatch[2];
                    i++;

                    // Collect text lines
                    let text = '';
                    while (i < lines.length && lines[i].trim() !== '' && !/^\d+$/.test(lines[i].trim()) && !lines[i].includes('-->')) {
                        text += (text ? '\n' : '') + lines[i].trim();
                        i++;
                    }

                    if (text) {
                        blocks.push({ start, end, text });
                    }
                } else {
                    i++;
                }
            }

            return blocks;
        }

        function parseTimestamp(timestamp) {
            const parts = timestamp.split(':');
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            const secondsParts = parts[2].split(',');
            const seconds = parseInt(secondsParts[0], 10);
            const milliseconds = parseInt(secondsParts[1], 10);
            return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
        }

        // ========================================
        // LOCAL STORAGE
        // ========================================
        function saveState() {
            try {
                const state = {
                    fileName: fileNameInput.value,
                    textInput: textInput.value,
                    charCount: charCountInput.value,
                    wordCount: wordCountInput.value,
                    readingRate: readingRateInput.value,
                    timestamp: Date.now()
                };
                localStorage.setItem('otimizadorGoldState', JSON.stringify(state));
            } catch (e) {}
        }

        function restoreState() {
            try {
                const savedState = localStorage.getItem('otimizadorGoldState');
                if (!savedState) return;

                const state = JSON.parse(savedState);
                if (Date.now() - state.timestamp > 3600000) {
                    localStorage.removeItem('otimizadorGoldState');
                    return;
                }

                if (state.fileName) fileNameInput.value = state.fileName;
                if (state.textInput) textInput.value = state.textInput;
                if (state.charCount) charCountInput.value = state.charCount;
                if (state.wordCount) wordCountInput.value = state.wordCount;
                if (state.readingRate) readingRateInput.value = state.readingRate;
            } catch (e) {}
        }

        restoreState();
        setInterval(saveState, 5000);
    });
    </script>
</body>
</html>
